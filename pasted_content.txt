#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
Katabump é’é¾™/Alpine ç¨³å®šç‰ˆ (v4.3 - Force Jump)

æ ¸å¿ƒä¿®å¤ï¼š
- åºŸé™¤â€œè·³è¿‡ç™»å½•â€çš„åˆ¤æ–­ï¼Œè§£å†³â€œå‡ç™»å½•â€å¯¼è‡´çš„æ­»å¾ªç¯ã€‚
- é€»è¾‘æ”¹ä¸ºï¼šç›´æ¥è®¿é—®ç»­æœŸé“¾æ¥ -> è‹¥è¢«æ‹¦æˆªåˆ°ç™»å½•é¡µ -> å¼ºåˆ¶ç™»å½• -> å†æ¬¡è®¿é—®ç»­æœŸé“¾æ¥ã€‚
- åªæœ‰çœŸæ­£åœç•™åœ¨ç»­æœŸé¡µï¼ˆedité¡µï¼‰æ—¶ï¼Œæ‰å¼€å§‹ç‚¹ Renewã€‚
"""

import os
import io
import json
import time
import zipfile
import shutil
import socket
import datetime
import requests
from DrissionPage import ChromiumPage, ChromiumOptions

# ==================== é’é¾™é€šçŸ¥é€‚é… ====================
try:
    from notify import send
except Exception:
    def send(title, content):
        print(f"ã€é€šçŸ¥é¢„è§ˆã€‘{title}\n{content}")

BASE_DIR = os.path.dirname(os.path.abspath(__file__))
EXT_DIR = os.path.join(BASE_DIR, "extensions")
os.makedirs(EXT_DIR, exist_ok=True)

notify_msg = []

def log(message: str):
    ts = datetime.datetime.now().strftime("%H:%M:%S")
    print(f"[{ts}] {message}", flush=True)
    notify_msg.append(message)

def _find_manifest_dir(root_dir: str):
    if not root_dir or not os.path.exists(root_dir):
        return None
    for root, _, files in os.walk(root_dir):
        if "manifest.json" in files:
            return os.path.abspath(root)
    return None

def _read_manifest_info(ext_dir: str):
    try:
        mf = os.path.join(ext_dir, "manifest.json")
        with open(mf, "r", encoding="utf-8") as f:
            data = json.load(f)
        return data.get("name", ""), data.get("version", "")
    except Exception:
        return "", ""

# ==================== æ’ä»¶ä¸‹è½½é€»è¾‘ ====================
def _crx_to_zip_bytes(crx_bytes: bytes) -> bytes:
    sig = b"PK\x03\x04"
    idx = crx_bytes.find(sig)
    return crx_bytes[idx:] if idx != -1 else b""

def download_silk():
    extract_root = os.path.join(EXT_DIR, "silk_ext")
    existed = _find_manifest_dir(extract_root)
    if existed:
        name, ver = _read_manifest_info(existed)
        log(f"âœ… [æ’ä»¶1] Silk å·²å­˜åœ¨: {existed} | {name} {ver}".strip())
        return existed

    log("â¬‡ï¸ [æ’ä»¶1] æ­£åœ¨ä¸‹è½½ Silk ...")
    url = ("https://clients2.google.com/service/update2/crx?"
           "response=redirect&prodversion=122.0&acceptformat=crx2,crx3&"
           "x=id%3Dajhmfdgkijocedmfjonnpjfojldioehi%26uc")
    try:
        resp = requests.get(url, headers={"User-Agent": "Mozilla/5.0"}, timeout=30)
        if resp.status_code != 200: return None
        payload = _crx_to_zip_bytes(resp.content)
        if not payload: return None
        os.makedirs(extract_root, exist_ok=True)
        with zipfile.ZipFile(io.BytesIO(payload)) as zf:
            zf.extractall(extract_root)
        return _find_manifest_dir(extract_root)
    except Exception:
        return None

def download_buyi06_cf():
    extract_root = os.path.join(EXT_DIR, "buyi06_cf_root")
    existed = _find_manifest_dir(extract_root)
    if existed:
        name, ver = _read_manifest_info(existed)
        log(f"âœ… [æ’ä»¶2] buyi06/cf å·²å­˜åœ¨: {existed} | {name} {ver}".strip())
        return existed

    log("â¬‡ï¸ [æ’ä»¶2] æ­£åœ¨ä¸‹è½½ buyi06/cf ...")
    url = "https://codeload.github.com/buyi06/cf/zip/refs/heads/master"
    try:
        resp = requests.get(url, headers={"User-Agent": "Mozilla/5.0"}, timeout=30)
        if resp.status_code != 200: return None
        os.makedirs(extract_root, exist_ok=True)
        with zipfile.ZipFile(io.BytesIO(resp.content)) as zf:
            zf.extractall(extract_root)
        return _find_manifest_dir(extract_root)
    except Exception:
        return None

# ==================== æµè§ˆå™¨é…ç½® ====================
def _pick_browser_path():
    env_path = os.environ.get("KB_CHROME_PATH", "").strip()
    if env_path and os.path.exists(env_path): return env_path
    alpine = "/usr/bin/chromium-browser"
    if os.path.exists(alpine): return alpine
    return shutil.which("chromium") or shutil.which("chromium-browser")

def _free_port():
    s = socket.socket()
    s.bind(('', 0))
    port = s.getsockname()[1]
    s.close()
    return port

def get_page():
    browser_path = _pick_browser_path()
    if not browser_path:
        log("âŒ æœªæ‰¾åˆ°æµè§ˆå™¨è·¯å¾„ï¼Œè¯·å®‰è£… chromium")
        exit(1)
        
    log(f"ğŸ”§ é”å®šæµè§ˆå™¨è·¯å¾„: {browser_path}")
    
    silk = download_silk()
    cf_ext = download_buyi06_cf()
    
    co = ChromiumOptions()
    co.set_browser_path(browser_path)
    co.set_argument('--headless=new') # æ— å¤´æ¨¡å¼
    co.set_user_agent("Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36")
    co.set_argument('--window-size=1920,1080')
    co.set_argument('--no-sandbox')
    co.set_argument('--disable-gpu')
    co.set_argument('--disable-infobars')
    co.set_argument('--disable-dev-shm-usage')
    co.set_argument('--no-zygote')
    co.set_argument('--disable-blink-features=AutomationControlled')
    
    if silk: co.add_extension(silk)
    if cf_ext: co.add_extension(cf_ext)
    
    co.set_local_port(_free_port())
    
    return ChromiumPage(addr_or_opts=co)

# ==================== ä¸»é€»è¾‘ ====================
def main():
    KB_USER = os.environ.get("KB_EMAIL", "") 
    KB_PWD = os.environ.get("KB_PASSWORD", "")
    KB_RENEW_URL = os.environ.get("KB_RENEW_URL", "")

    if not KB_USER or not KB_PWD or not KB_RENEW_URL:
        log("âŒ å˜é‡ç¼ºå¤±: KB_EMAIL / KB_PASSWORD / KB_RENEW_URL")
        return

    try:
        page = get_page()
    except Exception as e:
        log(f"âŒ æµè§ˆå™¨å¯åŠ¨å¤±è´¥: {e}")
        return
    
    MAX_RETRIES = 5
    
    for i in range(1, MAX_RETRIES + 1):
        try:
            log(f"ğŸš€ å¼€å§‹æ‰§è¡Œ... (ç¬¬ {i}/{MAX_RETRIES} æ¬¡)")
            
            # --- æ­¥éª¤ 1: ç›´æ¥å†²å‘ç»­æœŸ URL ---
            # ä¸å†å…ˆè®¿é—® /login åˆ¤æ–­ï¼Œè€Œæ˜¯ç›´æ¥è®¿é—®ç›®æ ‡ï¼Œè®©æœåŠ¡å™¨å†³å®šæ˜¯å¦æ‹¦æˆª
            log(f"â¡ï¸ ç›´æ¥è®¿é—®ç›®æ ‡é“¾æ¥: {KB_RENEW_URL}")
            page.get(KB_RENEW_URL)
            time.sleep(5)
            
            # --- æ­¥éª¤ 2: ç™»å½•æ‹¦æˆªå¤„ç† ---
            # å¦‚æœå½“å‰ URL å˜æˆäº† loginï¼Œæˆ–è€…é¡µé¢é‡Œæœ‰ email è¾“å…¥æ¡†ï¼Œè¯´æ˜ Session æ— æ•ˆï¼Œå¿…é¡»ç™»å½•
            if "login" in page.url or page.ele('css:input[name="email"]'):
                log("ğŸš§ ç›®æ ‡é“¾æ¥å°†æˆ‘ä»¬é‡å®šå‘åˆ°äº†ç™»å½•é¡µï¼Œå¼€å§‹ç™»å½•...")
                
                ele_email = page.ele('css:input[name="email"]', timeout=3)
                ele_pass = page.ele('css:input[name="password"]', timeout=3)
                btn_submit = page.ele('css:button[type="submit"]', timeout=3)

                if ele_email and ele_pass and btn_submit:
                    ele_email.input(KB_USER)
                    ele_pass.input(KB_PWD)
                    time.sleep(1)
                    btn_submit.click()
                    log("âœ… æäº¤äº†ç™»å½•è¡¨å•ï¼Œç­‰å¾…è·³è½¬...")
                    time.sleep(5) # ç­‰å¾…ç™»å½•å®Œæˆ
                else:
                    log("âŒ åˆ°äº†ç™»å½•é¡µä½†æ‰¾ä¸åˆ°è¾“å…¥æ¡† (å¯èƒ½è¢« CF éªŒè¯ç æ‹¦æˆª)")
                    # è¿™é‡Œä¸ continueï¼Œè®©å®ƒå¾€ä¸‹èµ°ï¼Œçœ‹çœ‹èƒ½ä¸èƒ½åˆ·æ–°å‡ºæ¥
            
            # --- æ­¥éª¤ 3: ç™»å½•åå†æ¬¡ç¡®è®¤ä½ç½® ---
            # ç™»å½•æˆåŠŸåï¼Œæœ‰æ—¶ä¼šåœåœ¨ /dashboardï¼Œè€Œä¸æ˜¯æˆ‘ä»¬åˆšæ‰æƒ³å»çš„ /servers/edit
            # æ‰€ä»¥è¿™é‡Œå¿…é¡»å¼ºåˆ¶æ£€æŸ¥ï¼Œå¦‚æœä¸åœ¨ edit é¡µï¼Œå†è·³ä¸€æ¬¡
            if "edit" not in page.url:
                log(f"ğŸ”„ ç™»å½•å®Œæˆï¼Œå†æ¬¡å¼ºåˆ¶è·³è½¬åˆ°: {KB_RENEW_URL}")
                page.get(KB_RENEW_URL)
                time.sleep(5)

            # æœ€ç»ˆæ£€æŸ¥ï¼šè¿˜åœ¨ç™»å½•é¡µå—ï¼Ÿ
            if "login" in page.url:
                log("âš ï¸ å°è¯•ç™»å½•å¹¶è·³è½¬åï¼Œä¾ç„¶åœ¨ç™»å½•é¡µï¼Œé‡è¯•æœ¬æ¬¡å¾ªç¯...")
                continue
                
            # --- æ­¥éª¤ 4: æŸ¥æ‰¾å¹¶ç‚¹å‡» Renew ---
            log("ğŸ” å·²åˆ°è¾¾ç›®æ ‡é¡µï¼ŒæŸ¥æ‰¾ Renew æŒ‰é’®...")
            renew_btn = page.ele('css:button[data-bs-toggle="modal"][data-bs-target="#renew-modal"]', timeout=10)
            
            if not renew_btn:
                log("âš ï¸ æœªæ‰¾åˆ°æŒ‰é’®ï¼Œå°è¯•æ–‡æœ¬æŸ¥æ‰¾...")
                renew_btn = page.ele('text:Renew', timeout=5)
                if not renew_btn:
                    log("âŒ å½»åº•æœªæ‰¾åˆ° Renew æŒ‰é’® (å¯èƒ½ URL ä¸å¯¹æˆ–æœåŠ¡å™¨å·²è¿‡æœŸ)ï¼Œé‡è¯•")
                    continue
            
            # æ»šåŠ¨å¹¶ç‚¹å‡»
            try:
                renew_btn.scroll.to_see()
                time.sleep(1)
            except Exception:
                pass

            renew_btn.click()
            log("âœ… ç‚¹å‡» Renewï¼Œç­‰å¾…å¼¹çª—...")
            time.sleep(3) 

            # --- æ­¥éª¤ 5: ç­‰å¾… Turnstile ---
            max_wait_ts = 60
            start_ts = time.time()
            cf_success = False
            
            log("â³ ç­‰å¾… Turnstile éªŒè¯...")
            
            while time.time() - start_ts < max_wait_ts:
                try:
                    resp_ele = page.ele('css:input[name="cf-turnstile-response"]', timeout=1)
                    if resp_ele:
                        val = resp_ele.attr("value")
                        if val and len(val) > 20:
                            log("âœ… Turnstile éªŒè¯é€šè¿‡")
                            cf_success = True
                            break
                    if page.ele('text:Error verifying Turnstile'):
                        break
                except Exception:
                    pass
                time.sleep(2)
                print(".", end="", flush=True)

            print("") 

            if not cf_success:
                log("âš ï¸ éªŒè¯ç è¶…æ—¶ï¼Œåˆ·æ–°é‡è¯•")
                page.refresh()
                continue
            
            # --- æ­¥éª¤ 6: æäº¤ ---
            confirm_btn = page.ele('css:#renew-modal button[type="submit"]', timeout=5)
            if confirm_btn:
                confirm_btn.click()
                log("âœ… å·²ç‚¹å‡»æäº¤")
                time.sleep(5)
                
                html_lower = page.html.lower()
                if "success" in html_lower or "renewed" in html_lower:
                    log("ğŸ‰ ç»­æœŸæˆåŠŸï¼")
                    send("KataBump ç»­æœŸ", f"è´¦å· {KB_USER} ç»­æœŸæˆåŠŸã€‚")
                    break
                else:
                    log("â“ æœªæ£€æµ‹åˆ°æˆåŠŸæ ‡è¯†ï¼Œä½†æµç¨‹å·²èµ°å®Œã€‚")
                    break
            else:
                log("âŒ æ‰¾ä¸åˆ°ç¡®è®¤æŒ‰é’®")
                continue

        except Exception as e:
            log(f"âŒ è¿è¡Œå¼‚å¸¸: {e}")
            time.sleep(3)

    log("ğŸ è„šæœ¬ç»“æŸ")
    page.quit()

if __name__ == "__main__":
    main()
